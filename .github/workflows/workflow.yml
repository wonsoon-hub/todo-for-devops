# .github/workflows/workflow.yml
# Next.js CI/CD íŒŒì´í”„ë¼ì¸ (ê°•ì˜ìš©)

name: Next.js CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  APP_PATH: '/home/azureuser/app'

jobs:
  # =================================
  # ðŸ§ª CI ë‹¨ê³„: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # =================================
  build:
    runs-on: ubuntu-latest
    name: ðŸ”¨ Build and Test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/testdb
          NEXTAUTH_SECRET: test-secret
          NODE_ENV: test
        run: |
          if npm run | grep -q "test"; then
            npm test
          else
            echo "No tests configured"
          fi

      - name: ðŸ”¨ Build application
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXTAUTH_SECRET: build-time-secret
          NODE_ENV: production
        run: |
          echo "ðŸ”¨ Starting Next.js build..."
          echo "ðŸ“‹ Current directory contents:"
          ls -la
          
          echo "ðŸ“‹ Package.json scripts:"
          cat package.json | grep -A 10 '"scripts"'
          
          echo "ðŸš€ Running npm run build..."
          npm run build
          
          echo "ðŸ“‹ Post-build directory contents:"
          ls -la
          
          if [ -d ".next" ]; then
            echo "âœ… .next directory created successfully"
            echo "ðŸ“Š Build size: $(du -sh .next | cut -f1)"
            echo "ðŸ“‹ .next contents:"
            ls -la .next/
          else
            echo "âŒ .next directory NOT FOUND!"
            echo "ðŸ“‹ Checking for build output in other locations:"
            find . -name "BUILD_ID" -o -name "*.js.map" -o -name "chunks" 2>/dev/null || echo "No build artifacts found"
            exit 1
          fi

      - name: ðŸ“¦ Create deployment package
        run: |
          echo "ðŸ“¦ Creating complete deployment package with dependencies..."
          mkdir -p deployment-package
          
          # ë¹Œë“œëœ Next.js íŒŒì¼ë“¤
          cp -r .next/ deployment-package/
          
          # ëŸ°íƒ€ìž„ í•„ìš” íŒŒì¼ë“¤
          cp package.json deployment-package/
          cp package-lock.json deployment-package/
          
          # í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜í•˜ì—¬ í¬í•¨
          cd deployment-package
          npm ci --only=production
          cd ..
          
          # ì„ íƒì  íŒŒì¼ë“¤
          [ -d "public" ] && cp -r public/ deployment-package/
          [ -d "prisma" ] && cp -r prisma/ deployment-package/
          [ -f "next.config.js" ] && cp next.config.js deployment-package/
          
          echo "ðŸ“Š Complete package created:"
          echo "  Build artifacts: $(du -sh deployment-package/.next | cut -f1)"
          echo "  Dependencies: $(du -sh deployment-package/node_modules | cut -f1)"
          echo "  Total size: $(du -sh deployment-package | cut -f1)"

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: deployment-package/
          retention-days: 7

  # =================================
  # ðŸš€ CD ë‹¨ê³„: ë°°í¬
  # =================================
  deploy:
    runs-on: ubuntu-latest
    name: ðŸš€ Deploy to Production
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./app-bundle/

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ”§ Add known hosts
        run: ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: â¹ï¸ Stop current application
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            pm2 stop todo-app 2>/dev/null || true
            pm2 delete todo-app 2>/dev/null || true
          "

      - name: ðŸ—‘ï¸ Backup and cleanup
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            [ -d '$APP_PATH' ] && mv $APP_PATH $APP_PATH.backup.\$(date +%s)
            mkdir -p $APP_PATH
          "

      - name: ðŸ“¦ Deploy new version
        run: scp -r app-bundle/* azureuser@${{ secrets.VM_HOST }}:$APP_PATH/

      - name: âš™ï¸ Configure environment
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            cat > .env.local << 'EOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=http://${{ secrets.VM_HOST }}:3000
          NODE_ENV=production
          EOF
          "

      - name: ðŸ“¦ Install production dependencies
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            npm ci --only=production
          "

      - name: ðŸ—„ï¸ Setup database
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
          
            if [ -f 'prisma/schema.prisma' ]; then
              echo 'ðŸ”§ Setting up Prisma database...'
          
              # .env.local íŒŒì¼ì´ ìžˆëŠ”ì§€ í™•ì¸
              if [ -f '.env.local' ]; then
                echo 'âœ… Environment file found'
          
                # í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¡œë“œí•˜ì—¬ Prisma ì‹¤í–‰
                set -a  # í™˜ê²½ ë³€ìˆ˜ ìžë™ export
                source .env.local
                set +a
          
                npx prisma generate
                npx prisma db push
          
                echo 'âœ… Database setup completed'
              else
                echo 'âŒ .env.local file not found'
                exit 1
              fi
            else
              echo 'â„¹ï¸  No Prisma schema found, skipping database setup'
            fi
          "

      - name: ðŸŒ Configure Nginx
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            sudo tee /etc/nginx/sites-available/todo-app << 'EOF'
          server {
              listen 80 default_server;
              server_name _;
          
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          EOF
          
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo ln -sf /etc/nginx/sites-available/todo-app /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx
          "

      - name: ðŸš€ Start application
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            pm2 start npm --name todo-app -- start
            pm2 save
          "

      - name: ðŸ¥ Health check
        run: |
          sleep 30
          curl -f http://${{ secrets.VM_HOST }}
          echo "âœ… Deployment successful!"

      - name: ðŸ“Š Deployment summary
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸŒ Application URL: http://${{ secrets.VM_HOST }}"
          echo "ðŸ“Š Commit: ${{ github.sha }}"