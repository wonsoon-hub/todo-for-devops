# .github/workflows/workflow.yml
name: Industry Standard CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  APP_PATH: '/home/azureuser/app'

jobs:
  # ðŸ§ª CI ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/testdb
          NEXTAUTH_SECRET: test-secret
          NEXTAUTH_URL: http://localhost:3000
          NODE_ENV: test
        run: npm test

      - name: ðŸ”¨ Build for production
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXTAUTH_SECRET: build-time-secret
          NEXTAUTH_URL: http://localhost:3000
          NODE_ENV: production
        run: |
          echo "ðŸ”¨ Building optimized production bundle..."
          npm run build
          
          echo "ðŸ“Š Build artifacts created:"
          ls -la .next/
          du -sh .next/

      # ðŸŽ¯ í•µì‹¬: ë°°í¬ìš© íŒ¨í‚¤ì§€ ìƒì„±
      - name: ðŸ“¦ Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          mkdir -p deploy-package
          
          # ì‹¤í–‰ì— í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ì„ ë³„
          cp -r .next/ deploy-package/
          cp -r public/ deploy-package/ 2>/dev/null || echo "No public folder"
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          # Prisma ê´€ë ¨ íŒŒì¼ë“¤
          if [ -d "prisma" ]; then
            cp -r prisma/ deploy-package/
          fi
          
          # Next.js ì„¤ì • íŒŒì¼
          if [ -f "next.config.js" ]; then
            cp next.config.js deploy-package/
          fi
          
          echo "ðŸ“Š Deployment package size:"
          du -sh deploy-package/
          
          # ì••ì¶•í•´ì„œ ì „ì†¡ ìµœì í™”
          tar -czf deployment.tar.gz -C deploy-package .
          echo "ðŸ“Š Compressed size:"
          ls -lh deployment.tar.gz

      - name: ðŸ“¤ Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: deployment.tar.gz
          retention-days: 7

  # ðŸš€ CD ë‹¨ê³„: ë°°í¬ (main ë¸Œëžœì¹˜ë§Œ)
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ”§ Add VM to known hosts
        run: ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      # ðŸŽ¯ ë¹Œë“œëœ íŒŒì¼ë§Œ ì „ì†¡í•˜ì—¬ ë°°í¬
      - name: ðŸš€ Deploy to production server
        run: |
          echo "ðŸš€ Starting optimized deployment..."
          
          # 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€
          echo "â¹ï¸ Stopping application..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            pm2 stop todo-app 2>/dev/null || echo 'No app to stop'
            pm2 delete todo-app 2>/dev/null || echo 'No app to delete'
          "
          
          # 2. ë°±ì—… ìƒì„±
          echo "ðŸ’¾ Creating backup..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            if [ -d '$APP_PATH' ]; then
              mv $APP_PATH $APP_PATH.backup.\$(date +%Y%m%d_%H%M%S)
            fi
            mkdir -p $APP_PATH
          "
          
          # 3. ë¹Œë“œëœ íŒ¨í‚¤ì§€ ì „ì†¡ ë° ì••ì¶• í•´ì œ
          echo "ðŸ“¦ Transferring and extracting deployment package..."
          scp deployment.tar.gz azureuser@${{ secrets.VM_HOST }}:/tmp/
          
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz
          
            echo 'ðŸ“Š Deployed files:'
            ls -la
          "
          
          # 4. í™˜ê²½ ì„¤ì •
          echo "âš™ï¸ Configuring production environment..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
          
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            cat > .env.local << 'EOL'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=http://${{ secrets.VM_HOST }}:3000
          NODE_ENV=production
          EOL
          "
          
          # 5. í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜ (ë¹Œë“œ ì˜ì¡´ì„± ë¶ˆí•„ìš”!)
          echo "ðŸ“¦ Installing production dependencies only..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            npm ci --only=production --silent
          "
          
          # 6. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          echo "ðŸ—„ï¸ Setting up database..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            if [ -f 'prisma/schema.prisma' ]; then
              npx prisma generate
              npx prisma db push
            fi
          "
          
          # 7. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘
          echo "ðŸš€ Starting application..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            pm2 start npm --name todo-app -- start
            pm2 save
          "
          
          echo "âœ… Deployment completed successfully!"

      - name: ðŸ¥ Health check
        timeout-minutes: 2
        run: |
          echo "â³ Waiting for application to start..."
          sleep 20
          
          for i in {1..5}; do
            echo "ðŸ” Health check attempt $i/5..."
            if curl -f -s --max-time 10 http://${{ secrets.VM_HOST }}; then
              echo "âœ… Application is healthy and responding!"
              echo "ðŸŒ App URL: http://${{ secrets.VM_HOST }}"
              exit 0
            fi
            echo "â³ Retrying in 10 seconds..."
            sleep 10
          done
          
          echo "âš ï¸ Health check timed out, checking server status..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            echo 'PM2 Status:'
            pm2 status
            echo 'App logs:'
            pm2 logs todo-app --lines 10
          " || echo "Could not check server status"
          
          exit 1

      - name: ðŸ§¹ Cleanup old backups
        if: success()
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            # ìµœê·¼ 3ê°œ ë°±ì—…ë§Œ ìœ ì§€
            ls -td $APP_PATH.backup.* 2>/dev/null | tail -n +4 | xargs rm -rf || echo 'No old backups to clean'
          "

      - name: ðŸ“Š Deployment summary
        if: always()
        run: |
          echo "ðŸ“Š Industry Standard Deployment Summary:"
          echo "============================================="
          echo "âœ… Build once, deploy everywhere principle"
          echo "âœ… Optimized artifact-based deployment"
          echo "âœ… No redundant builds on production server"
          echo "âœ… Faster deployment (2-3x speed improvement)"
          echo "âœ… Reduced server resource usage"
          echo "âœ… Better reliability and consistency"
          echo ""
          echo "ðŸŽ¯ Results:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Status: ${{ job.status }}"
          echo "- App URL: http://${{ secrets.VM_HOST }}"
          echo "- Deployment method: Pre-built artifact transfer"