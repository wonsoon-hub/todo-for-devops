# .github/workflows/deploy.yml
# Next.js + GitHub Actions + Azure VM 2ëŒ€ ë°°í¬ (ê°•ì˜ìš©)

name: Next.js CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  APP_PATH: '/home/azureuser/app'

jobs:
  # =======================
  # ğŸ§ª CI: Build & Test
  # =======================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“… Checkout code
        uses: actions/checkout@v4

      - name: â™»ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… Run tests
        run: |
          if npm run | grep -q test; then npm test; else echo "No tests defined."; fi

      - name: ğŸ”¨ Build app
        run: npm run build

      - name: ğŸ“¦ Package app
        run: |
          mkdir -p deployment-package

          # ë””ë ‰í† ë¦¬ ë³µì‚¬ (ì¡´ì¬í•  ë•Œë§Œ)
          for path in .next node_modules public prisma; do
            if [ -e "$path" ]; then
              echo "ğŸ“ Copying $path"
              cp -r "$path" deployment-package/
            else
              echo "âš ï¸ $path not found, skipping"
            fi
          done

          # íŒŒì¼ ë³µì‚¬ (ì¡´ì¬í•  ë•Œë§Œ)
          for file in package.json package-lock.json next.config.js; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ Copying $file"
              cp "$file" deployment-package/
            else
              echo "âš ï¸ $file not found, skipping"
            fi
          done

      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle
          path: deployment-package/

  # =======================
  # ğŸš€ CD: Deploy to Azure VM
  # =======================
  deploy:
    name: ğŸš€ Deploy to Azure VM
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download build
        uses: actions/download-artifact@v4
        with:
          name: app-bundle
          path: ./app-bundle

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ›  Add known hosts
        run: ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: â¹ Stop old app
        run: ssh azureuser@${{ secrets.VM_HOST }} "pm2 stop todo-app || true && pm2 delete todo-app || true"

      - name: ğŸ—‘ Clean & prepare folder
        run: ssh azureuser@${{ secrets.VM_HOST }} "rm -rf $APP_PATH && mkdir -p $APP_PATH"

      - name: ğŸ“¦ Package app
        run: |
          tar -czf app.tar.gz \
            --exclude='node_modules' \
            -C ./app-bundle \
            .next public prisma package.json package-lock.json next.config.js || echo "âš ï¸ ì¼ë¶€ íŒŒì¼ ëˆ„ë½, ê³„ì† ì§„í–‰"

      - name: ğŸ“¦ Upload app to VM
        run: scp app.tar.gz azureuser@${{ secrets.VM_HOST }}:$APP_PATH/

      - name: ğŸ“¦ Extract and install on VM
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH && \
            tar -xzf app.tar.gz && \
            rm app.tar.gz && \
            npm ci --only=production
          "

      - name: âš–ï¸ Setup .env.local
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH && \
            echo 'DATABASE_URL=${{ secrets.DATABASE_URL }}' > .env.local && \
            echo 'NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}' >> .env.local && \
            echo 'NEXTAUTH_URL=http://${{ secrets.VM_HOST }}:3000' >> .env.local && \
            echo 'NODE_ENV=production' >> .env.local
          "

      - name: ğŸ“ Setup Prisma
        run: ssh azureuser@${{ secrets.VM_HOST }} "cd $APP_PATH && source .env.local && npx prisma generate && npx prisma db push"

      - name: ğŸ”¨ Start app via PM2
        run: ssh azureuser@${{ secrets.VM_HOST }} "cd $APP_PATH && pm2 start npm --name todo-app -- start && pm2 save"

      - name: ğŸš¨ Health check
        run: |
          sleep 10
          if curl -f http://${{ secrets.VM_HOST }}; then
            echo "âœ… App running successfully"
          else
            echo "âŒ Health check failed"
            ssh azureuser@${{ secrets.VM_HOST }} "pm2 logs todo-app --lines 50"
            exit 1
          fi

      - name: ğŸ“Š Deployment summary
        run: echo "ğŸ‰ Deployed to http://${{ secrets.VM_HOST }}"
