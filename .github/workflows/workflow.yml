# .github/workflows/workflow.yml
name: Todo App CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  APP_PATH: '/home/azureuser/app'

jobs:
  ci-cd:
    runs-on: ubuntu-latest

    # PostgreSQL ì„œë¹„ìŠ¤ (í…ŒìŠ¤íŠ¸ìš©)
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # CI ë‹¨ê³„
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Setup test database
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb
        run: |
          # Prisma ìŠ¤í‚¤ë§ˆ íŒŒì¼ì´ ìžˆì„ ë•Œë§Œ ì‹¤í–‰
          if [ -f "prisma/schema.prisma" ]; then
            npx prisma generate
            npx prisma db push
            echo "âœ… Test database setup completed"
          else
            echo "âš ï¸ Prisma schema not found, skipping database setup"
          fi

      - name: âœ… Run tests
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb
          NEXTAUTH_SECRET: test-secret
          NEXTAUTH_URL: http://localhost:3000
        run: |
          # package.jsonì— test ìŠ¤í¬ë¦½íŠ¸ê°€ ìžˆëŠ”ì§€ í™•ì¸
          if npm run | grep -q "test"; then
            npm test
            echo "âœ… Tests completed successfully"
          else
            echo "âš ï¸ No test script found, skipping tests"
            echo "âœ… Tests skipped successfully"
          fi

      - name: ðŸ”¨ Build application
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb
          NEXTAUTH_SECRET: test-secret
          NEXTAUTH_URL: http://localhost:3000
        run: npm run build

      # CD ë‹¨ê³„ (main ë¸Œëžœì¹˜ë§Œ)
      - name: ðŸš€ Deploy to Azure VM
        if: github.ref == 'refs/heads/main'
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ”§ Add VM to known hosts
        if: github.ref == 'refs/heads/main'
        run: |
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Deploy application
        if: github.ref == 'refs/heads/main'
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            echo 'â¹ï¸ Stopping application...'
            pm2 stop todo-app 2>/dev/null || echo 'No existing app to stop'
            pm2 delete todo-app 2>/dev/null || echo 'No existing app to delete'
          
            echo 'ðŸ—‘ï¸ Removing old application...'
            rm -rf $APP_PATH
          
            echo 'ðŸ“¥ Cloning new version...'
            git clone https://github.com/soongon/todo-for-devops.git $APP_PATH
            cd $APP_PATH
          
            echo 'âš™ï¸ Setting up environment...'
            cat > .env.local << 'EOL'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=http://${{ secrets.VM_HOST }}:3000
          NODE_ENV=production
          EOL
          
            echo 'ðŸ“¦ Installing dependencies...'
            # ë©”ëª¨ë¦¬ ë¶€ì¡± ë°©ì§€ë¥¼ ìœ„í•œ ì˜µì…˜ ì¶”ê°€
            npm ci --prefer-offline --no-audit --no-fund --quiet || {
              echo 'âš ï¸ npm ci failed, trying with reduced memory usage...'
              npm install --production --no-optional --no-audit --no-fund --quiet
            }
          
            echo 'ðŸ—„ï¸ Setting up database...'
            if [ -f 'prisma/schema.prisma' ]; then
              npx prisma generate
              npx prisma db push
              echo 'âœ… Database setup completed'
            else
              echo 'âš ï¸ No Prisma schema found, skipping database setup'
            fi
          
            echo 'ðŸ”¨ Building application...'
            npm run build
          
            echo 'ðŸš€ Starting application...'
            pm2 start npm --name todo-app -- start
            pm2 save
          
            echo 'ðŸ” Checking application status...'
            sleep 10
            pm2 status
            pm2 logs todo-app --lines 20
          
            echo 'ðŸ§ª Testing local connection...'
            curl -f http://localhost:3000 || echo 'Local connection failed'
          
            echo 'ðŸ”§ Configuring Nginx proxy...'
            sudo tee /etc/nginx/sites-available/todo-app << 'NGINX_EOF'
          server {
              listen 80;
              server_name _;
          
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;
              }
          }
          NGINX_EOF
          
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo ln -sf /etc/nginx/sites-available/todo-app /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx
          
            echo 'âœ… Deployment completed!'
          "

      - name: ðŸ¥ Health check and diagnostics
        if: github.ref == 'refs/heads/main'
        run: |
          echo "â³ Waiting for application to start..."
          sleep 30
          
          echo "ðŸ” Running detailed diagnostics..."
          
          # PM2 ìƒíƒœ í™•ì¸
          ssh azureuser@${{ secrets.VM_HOST }} "
            echo 'ðŸ“Š PM2 Status:'
            pm2 status
          
            echo 'ðŸ“‹ PM2 Logs (last 20 lines):'
            pm2 logs todo-app --lines 20 || echo 'No logs available'
          
            echo 'ðŸ”Œ Port 3000 check:'
            sudo netstat -tlnp | grep 3000 || echo 'Port 3000 not in use'
          
            echo 'ðŸ§ª Local curl test:'
            curl -v http://localhost:3000 || echo 'Local connection failed'
          
            echo 'ðŸ“ App directory contents:'
            ls -la /home/azureuser/app/
          
            echo 'âš™ï¸ Environment file:'
            cat /home/azureuser/app/.env.local || echo 'No .env.local file'
          
            echo 'ðŸ”§ Nginx status:'
            sudo systemctl status nginx --no-pager -l
          "
          
          echo "ðŸŒ External health check..."
          if curl -f -s http://${{ secrets.VM_HOST }}; then
            echo "âœ… Application is healthy!"
          else
            echo "âŒ External health check failed!"
            echo "â„¹ï¸  Check the diagnostics above for details"
            exit 1
          fi

      - name: ðŸ“ Deployment summary
        if: always() && github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ“Š Deployment Summary:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Status: ${{ job.status }}"
          echo "- App URL: http://${{ secrets.VM_HOST }}"