# .github/workflows/main.yml - ì•ˆì •ì ì¸ ì—…ê³„ í‘œì¤€ ë°©ì‹
name: Stable Industry Standard CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  APP_PATH: '/home/azureuser/app'

jobs:
  # ðŸ§ª CI ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/testdb
          NEXTAUTH_SECRET: test-secret
          NEXTAUTH_URL: http://localhost:3000
          NODE_ENV: test
        run: |
          if npm run | grep -q "test"; then
            echo "ðŸ§ª Running tests..."
            npm test
            echo "âœ… Tests completed successfully"
          else
            echo "âš ï¸ No test script found, skipping tests"
            echo "âœ… Tests skipped successfully"
          fi

      - name: ðŸ”¨ Build for production
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXTAUTH_SECRET: build-time-secret
          NEXTAUTH_URL: http://localhost:3000
          NODE_ENV: production
        run: |
          echo "ðŸ”¨ Building optimized production bundle..."
          npm run build
          
          echo "ðŸ“Š Build artifacts created:"
          ls -la .next/ || echo "No .next directory found"

      # ðŸŽ¯ ë°°í¬ìš© íŒ¨í‚¤ì§€ ìƒì„±
      - name: ðŸ“¦ Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          mkdir -p deploy-package
          
          # í•„ìˆ˜ íŒŒì¼ë“¤ ë³µì‚¬
          echo "Copying build files..."
          if [ -d ".next" ]; then
            cp -r .next/ deploy-package/
            echo "âœ… .next directory copied"
          else
            echo "âŒ .next directory not found!"
            exit 1
          fi
          
          if [ -d "public" ]; then
            cp -r public/ deploy-package/
            echo "âœ… public directory copied"
          else
            echo "âš ï¸ No public directory found"
          fi
          
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          echo "âœ… Package files copied"
          
          # Prisma ê´€ë ¨ íŒŒì¼ë“¤
          if [ -d "prisma" ]; then
            cp -r prisma/ deploy-package/
            echo "âœ… Prisma files copied"
          fi
          
          # Next.js ì„¤ì • íŒŒì¼
          if [ -f "next.config.js" ]; then
            cp next.config.js deploy-package/
            echo "âœ… Next.js config copied"
          fi
          
          echo "ðŸ“Š Deployment package contents:"
          ls -la deploy-package/
          
          echo "ðŸ“Š Package size:"
          du -sh deploy-package/

      - name: ðŸ“¤ Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: deploy-package/
          retention-days: 1
          if-no-files-found: error

      - name: ðŸ“Š Build job summary
        run: |
          echo "âœ… Build job completed successfully!"
          echo "ðŸ“¦ Artifacts uploaded for deployment"
          echo "ðŸ”„ Deploy job will start if this is main branch"

  # ðŸš€ CD ë‹¨ê³„: ë°°í¬ (main ë¸Œëžœì¹˜ë§Œ)
  deploy:
    runs-on: ubuntu-latest
    needs: build
    # main ë¸Œëžœì¹˜ì´ê³  ë¹Œë“œê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/main' && needs.build.result == 'success'

    steps:
      - name: ðŸŽ¯ Deploy job started
        run: |
          echo "ðŸš€ Starting deployment to production..."
          echo "ðŸ“‹ Job Info:"
          echo "  - Branch: ${{ github.ref }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Build Status: ${{ needs.build.result }}"

      - name: ðŸ“¥ Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./deployment/

      - name: ðŸ” Verify deployment package
        run: |
          echo "ðŸ“¦ Downloaded deployment package:"
          ls -la deployment/
          
          echo "ðŸ“Š Package size:"
          du -sh deployment/
          
          # í•„ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -d "deployment/.next" ]; then
            echo "âŒ .next directory missing!"
            exit 1
          fi
          
          if [ ! -f "deployment/package.json" ]; then
            echo "âŒ package.json missing!"
            exit 1
          fi
          
          echo "âœ… All required files present"

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ”§ Add VM to known hosts
        run: ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      # ðŸŽ¯ í•µì‹¬: ì•„í‹°íŒ©íŠ¸ ê¸°ë°˜ ë°°í¬
      - name: ðŸš€ Deploy to production server
        run: |
          echo "ðŸš€ Starting artifact-based deployment..."
          
          # 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€
          echo "â¹ï¸ Stopping current application..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            pm2 stop todo-app 2>/dev/null || echo 'No app running'
            pm2 delete todo-app 2>/dev/null || echo 'No app to delete'
          "
          
          # 2. ë°±ì—… ìƒì„±  
          echo "ðŸ’¾ Creating backup..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            if [ -d '$APP_PATH' ]; then
              sudo mv $APP_PATH $APP_PATH.backup.\$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            fi
            mkdir -p $APP_PATH
          "
          
          # 3. ìƒˆ ë²„ì „ ë°°í¬
          echo "ðŸ“¦ Deploying new version..."
          scp -r deployment/* azureuser@${{ secrets.VM_HOST }}:$APP_PATH/
          
          # 4. í™˜ê²½ ì„¤ì •
          echo "âš™ï¸ Setting up environment..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
          
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env.local << 'EOL'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=http://${{ secrets.VM_HOST }}:3000
          NODE_ENV=production
          EOL
          
            echo 'âœ… Environment configured'
          "
          
          # 5. í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ðŸ“¦ Installing production dependencies..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            npm ci --only=production --silent
            echo 'âœ… Dependencies installed'
          "
          
          # 6. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          echo "ðŸ—„ï¸ Setting up database..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            if [ -f 'prisma/schema.prisma' ]; then
              npx prisma generate
              npx prisma db push
              echo 'âœ… Database configured'
            else
              echo 'âš ï¸ No Prisma schema found'
            fi
          "
          
          # 7. Nginx í”„ë¡ì‹œ ì„¤ì •
          echo "ðŸ”§ Configuring Nginx proxy..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            sudo tee /etc/nginx/sites-available/todo-app << 'NGINX_EOF'
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _;
          
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;
              }
          }
          NGINX_EOF
          
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo ln -sf /etc/nginx/sites-available/todo-app /etc/nginx/sites-enabled/todo-app
            sudo nginx -t && sudo systemctl reload nginx
            echo 'âœ… Nginx configured'
          "
          
          # 8. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘
          echo "ðŸš€ Starting application..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH
            pm2 start npm --name todo-app -- start
            pm2 save
            echo 'âœ… Application started'
          "
          
          echo "âœ… Deployment completed!"

      - name: ðŸ¥ Health check
        timeout-minutes: 3
        run: |
          echo "â³ Waiting for application to start..."
          sleep 20
          
          echo "ðŸ” Running health checks..."
          for i in {1..5}; do
            echo "ðŸ©º Health check attempt $i/5..."
          
            if curl -f -s --max-time 10 http://${{ secrets.VM_HOST }}; then
              echo "âœ… Application is healthy and responding!"
              echo "ðŸŒ App URL: http://${{ secrets.VM_HOST }}"
              exit 0
            fi
          
            echo "â³ Retrying in 10 seconds..."
            sleep 10
          done
          
          echo "âŒ Health check failed, but checking server status..."
          ssh azureuser@${{ secrets.VM_HOST }} "
            echo 'ðŸ“Š PM2 Status:'
            pm2 status
            echo 'ðŸ“‹ Recent logs:'
            pm2 logs todo-app --lines 10 || echo 'No logs available'
            echo 'ðŸ”Œ Port check:'
            curl -s http://localhost:3000 | head -3 || echo 'Local connection failed'
          " || echo "Could not check server status"
          
          echo "âš ï¸ Manual verification may be required"
          exit 1

      - name: ðŸ“Š Deployment summary
        if: always()
        run: |
          echo "ðŸ“Š Deployment Summary"
          echo "===================="
          echo "âœ… Method: Artifact-based deployment"
          echo "âœ… No server-side building required"  
          echo "âœ… Optimized for speed and reliability"
          echo ""
          echo "ðŸ“‹ Details:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Build Job: ${{ needs.build.result }}"
          echo "- Deploy Status: ${{ job.status }}"
          echo "- App URL: http://${{ secrets.VM_HOST }}"