# .github/workflows/deploy.yml
# Next.js + GitHub Actions + Azure VM 2ëŒ€ ë°°í¬ (ê°•ì˜ìš©)

name: Next.js CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  APP_PATH: '/home/azureuser/app'

jobs:
  # =======================
  # ğŸ§ª CI: Build & Test
  # =======================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“… Checkout code
        uses: actions/checkout@v4

      - name: â™»ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”¨ Build app
        run: |
          mkdir -p app-bundle

          INCLUDE_LIST=""
          for path in .next public prisma package.json package-lock.json next.config.mjs .env.local; do
            [ -e "$path" ] && INCLUDE_LIST="$INCLUDE_LIST $path"
          done

          rsync -av $INCLUDE_LIST app-bundle/

          cd app-bundle
          npm ci
          npm run build

      - name: ğŸ” Check if .next folder exists
        run: |
          cd app-bundle
          if [ ! -d ".next" ]; then
            echo "âŒ .next folder is missing. Build might have failed."
            exit 1
          fi

      - name: ğŸ“¦ Package app
        run: |
          cd app-bundle
          mkdir -p ../deployment-package
          cp -r .next ../deployment-package/
          cp -r node_modules ../deployment-package/
          cp -r public ../deployment-package/
          cp -r prisma ../deployment-package/
          cp package.json ../deployment-package/
          cp package-lock.json ../deployment-package/
          cp next.config.mjs ../deployment-package/

      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle
          path: deployment-package/

  # =======================
  # ğŸš€ CD: Deploy to Azure VM
  # =======================
  deploy:
    name: ğŸš€ Deploy to Azure VM
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download build
        uses: actions/download-artifact@v4
        with:
          name: app-bundle
          path: ./app-bundle

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ›  Add known hosts
        run: ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: â¹ Stop old app
        run: ssh azureuser@${{ secrets.VM_HOST }} "pm2 stop todo-app || true && pm2 delete todo-app || true"

      - name: ğŸ—‘ Clean & prepare folder
        run: ssh azureuser@${{ secrets.VM_HOST }} "rm -rf $APP_PATH && mkdir -p $APP_PATH"

      - name: ğŸ“¦ Package app
        run: |
          tar -czf app.tar.gz \
            -C ./app-bundle \
            .next public prisma package.json package-lock.json next.config.mjs || echo "âš ï¸ ì¼ë¶€ íŒŒì¼ ëˆ„ë½, ê³„ì† ì§„í–‰"

      - name: ğŸ“¦ Upload app to VM
        run: scp app.tar.gz azureuser@${{ secrets.VM_HOST }}:$APP_PATH/

      - name: ğŸ“¦ Extract and install on VM
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH && \
            tar -xzf app.tar.gz && \
            rm app.tar.gz && \
            npm ci --only=production
          "

      - name: âš–ï¸ Setup .env.local
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH && \
            echo 'DATABASE_URL=${{ secrets.DATABASE_URL }}' > .env.local && \
            echo 'NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}' >> .env.local && \
            echo 'NEXTAUTH_URL=http://${{ secrets.VM_HOST }}:3000' >> .env.local && \
            echo 'NODE_ENV=production' >> .env.local
          "


      - name: ğŸ“ Setup Prisma
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH && \
            export \$(cat .env.local | xargs) && \
            npx prisma generate && \
            npx prisma db push
          "

      - name: ğŸ§ª Verify .next folder exists after extract
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            if [ ! -d '$APP_PATH/.next' ]; then
              echo 'âŒ .next not found after extraction.'
              ls -al $APP_PATH
              exit 1
            else
              echo 'âœ… .next folder found after extraction.'
            fi
          "

      - name: ğŸ”¨ Start app via PM2
        run: ssh azureuser@${{ secrets.VM_HOST }} "cd $APP_PATH && pm2 start npm --name todo-app -- start && pm2 save"

      - name: ğŸš¨ Health check
        run: |
          sleep 10
          if curl -f http://${{ secrets.VM_HOST }}; then
            echo "âœ… App running successfully"
          else
            echo "âŒ Health check failed"
            ssh azureuser@${{ secrets.VM_HOST }} "pm2 logs todo-app --lines 50"
            exit 1
          fi

      - name: ğŸ“Š Deployment summary
        run: echo "ğŸ‰ Deployed to http://${{ secrets.VM_HOST }}"

      - name: ğŸ” PM2 restart fallback (if not running)
        run: |
          ssh azureuser@${{ secrets.VM_HOST }} "
            cd $APP_PATH && \
            pm2 describe todo-app > /dev/null || pm2 start npm --name todo-app -- start && pm2 save
          "

      - name: ğŸ“Œ GitHub Action ë°°í¬ ë§ˆë¬´ë¦¬ ë¡œê·¸
        run: |
          echo "âœ… GitHub Actionsë¥¼ í†µí•œ ë°°í¬ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ğŸ“ ì ‘ê·¼ URL: http://${{ secrets.VM_HOST }}"
