name: ğŸš€ Deploy to Azure App Service (Docker Hub)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout source
        uses: actions/checkout@v3

      - name: ğŸ³ Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ— Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/todo-app .
          docker push ${{ secrets.DOCKER_USERNAME }}/todo-app

      - name: ğŸ” Azure CLI login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ›  Create Web App (if not exists)
        run: |
          if ! az webapp show --name todo-webapp-dev-kitri --resource-group rg-appservice-infrastructure-dev-04 &> /dev/null; then
            az webapp create \
              --resource-group rg-appservice-infrastructure-dev-04 \
              --plan asp-dev \
              --name todo-webapp-dev-kitri

            # ë°”ë¡œ ì»¨í…Œì´ë„ˆ ì„¤ì •
            az webapp config container set \
              --name todo-webapp-dev-kitri \
              --resource-group rg-appservice-infrastructure-dev-04 \
              --docker-custom-image-name ${{ secrets.DOCKER_USERNAME }}/todo-app \
              --docker-registry-server-url https://index.docker.io
          fi

      - name: âš™ï¸ Set App Service port setting
        run: |
          az webapp config appsettings set \
            --name todo-webapp-dev-kitri \
            --resource-group rg-appservice-infrastructure-dev-04 \
            --settings WEBSITES_PORT=3000

      - name: ğŸš€ Configure App Service to use Docker Hub
        run: |
          az webapp config container set \
            --name todo-webapp-dev-kitri \
            --resource-group rg-appservice-infrastructure-dev-04 \
            --container-image-name ${{ secrets.DOCKER_USERNAME }}/todo-app \
            --container-registry-url https://index.docker.io

      - name: ğŸ” Restart App Service
        run: |
          az webapp restart \
            --name todo-webapp-dev-kitri \
            --resource-group rg-appservice-infrastructure-dev-04