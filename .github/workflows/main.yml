# .github/workflows/main.yml

name: Deploy Next.js App to Azure VM

# 1. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  push:
    branches:
      - main

# 2. ì›Œí¬í”Œë¡œìš° ì¡(Job) ì •ì˜
jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    # 3. ë°°í¬ ë‹¨ê³„(Steps) ì •ì˜
    steps:
      # (1) ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # (2) Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      # (3) .env íŒŒì¼ ìƒì„± (DB ë° NextAuth ì •ë³´)
      # GitHub Secretsì— ì €ì¥ëœ ê°’ë“¤ì„ ì´ìš©í•´ .env.local íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Create .env file for build
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.local
          echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env.local

      # (4) ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      - name: Install dependencies and Build
        run: |
          npm install
          npm run build

      # (5) SCPë¥¼ ì´ìš©í•œ ë¹Œë“œ ê²°ê³¼ë¬¼ ì „ì†¡
      # ì‚¬ìš©ì Secret ì´ë¦„(VM_HOST, SSH_PRIVATE_KEY)ì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
      - name: Transfer build files to Azure VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: azureuser # Ansible ì„¤ì • íŒŒì¼ì— ëª…ì‹œëœ ì‚¬ìš©ì ì´ë¦„ì…ë‹ˆë‹¤.
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ".next, node_modules, package.json, public"
          target: "/home/azureuser/app"
          strip_components: 1

      # (6) SSHë¥¼ ì´ìš©í•œ ì›ê²© ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ì‚¬ìš©ì Secret ì´ë¦„(VM_HOST, SSH_PRIVATE_KEY)ì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
      - name: Deploy application on Azure VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: azureuser # Ansible ì„¤ì • íŒŒì¼ì— ëª…ì‹œëœ ì‚¬ìš©ì ì´ë¦„ì…ë‹ˆë‹¤.
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/azureuser/app
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¤‘ë‹¨ ì—†ì´ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
            pm2 reload todo-app --name "todo-app" -- start npm -- start || pm2 start npm --name "todo-app" -- start

            # PM2 í”„ë¡œì„¸ìŠ¤ ëª©ë¡ì„ ì €ì¥í•˜ì—¬ ì„œë²„ ì¬ë¶€íŒ… í›„ì—ë„ ìë™ ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
            pm2 save

            echo "ğŸš€ Deployment successful!"